
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>4.4. Time Series Outlier Detection: Visual Methods &#8212; Introduction to Time Series</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css?v=ca93fcec" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/myfile.css?v=564be945" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapter_04/Intro2TS_C04S04';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.6. Major Statistical Methods for Outlier Detection in Time Series" href="Intro2TS_C04S05.html" />
    <link rel="prev" title="4.3. Outlier Classification by Seasonality" href="Intro2TS_C04S03.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../Preface.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Introduction to Time Series - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Introduction to Time Series - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter_01/Intro2TS_C01.html">1. Introduction to Time Series</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_01/Intro2TS_C01S01.html">1.1. What are Time Series?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_01/Intro2TS_C01S02.html">1.2. Best Sources for Public Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_01/Intro2TS_C01S03.html">1.3. Time Series Cross-Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_01/Intro2TS_C01S04.html">1.4. Time Series Visualizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_01/Intro2TS_C01S05.html">1.5. What Are ACF and PACF?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_01/Intro2TS_C01S06.html">1.6. Cross-Correlation in Time Series</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter_02/Intro2TS_C02.html">2. Missing Data in Time Series</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_02/Intro2TS_C02S01.html">2.1. Types of Missing Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_02/Intro2TS_C02S02.html">2.2. Identifying Patterns of Missingness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_02/Intro2TS_C02S03.html">2.3. Handling Missing Values</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../chapter_03/Intro2TS_C03.html">3. Seasonality and Stationarity</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_03/Intro2TS_C03S01.html">3.1. Understanding Seasonality</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_03/Intro2TS_C03S02.html">3.2. Seasonal-Trend Decomposition using LOESS (STL)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_03/Intro2TS_C03S03.html">3.3. Additive vs. Multiplicative Decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_03/Intro2TS_C03S04.html">3.4. Robust STL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_03/Intro2TS_C03S05.html">3.5. Stationarity and Non-Stationarity in Time-Series Analysis</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Intro2TS_C04.html">4. Outlier Detection</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Intro2TS_C04S01.html">4.1. Outlier Detection in Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="Intro2TS_C04S02.html">4.2. Outlier Classification by Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="Intro2TS_C04S03.html">4.3. Outlier Classification by Seasonality</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">4.4. Time Series Outlier Detection: Visual Methods</a></li>

<li class="toctree-l2"><a class="reference internal" href="Intro2TS_C04S05.html">4.6. Major Statistical Methods for Outlier Detection in Time Series</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../References.html">5. References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Time Series Outlier Detection: Visual Methods</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">4.4. Time Series Outlier Detection: Visual Methods</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#time-plots-line-plots">4.4.1. Time Plots (Line Plots)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#histograms">4.4.2. Histograms</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#box-plots-box-and-whisker">4.4.3. Box Plots (Box-and-Whisker)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scatter-plots-lag-plots">4.4.4. Scatter Plots (Lag Plots)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#violin-plots-grouped-by-time-unit">4.4.5. Violin Plots (Grouped by Time Unit)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonal-decomposition-plots">4.4.6. Seasonal Decomposition Plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q-q-plots-quantile-quantile-plots">4.4.7. Q-Q Plots (Quantile-Quantile Plots)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#normal-probability-plots-alternative-to-q-q-plots">4.4.8. Normal Probability Plots (Alternative to Q-Q Plots)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#residual-plots">4.4.9. Residual Plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#control-charts-statistical-process-control">4.4.10. Control Charts (Statistical Process Control)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-tables-and-method-selection">4.5. Summary Tables and Method Selection</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-method-categories-and-use-cases">4.5.1. Visual Method Categories and Use Cases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-analysis-methods">4.5.1.1. Distribution Analysis Methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#relationship-and-pattern-methods">4.5.1.2. Relationship and Pattern Methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decomposition-and-monitoring-methods">4.5.1.3. Decomposition and Monitoring Methods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#method-selection-guidelines">4.5.2. Method Selection Guidelines</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-method-combinations-by-data-type">4.5.2.1. Recommended Method Combinations by Data Type</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-phase-recommendations">4.5.2.2. Analysis Phase Recommendations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-notable-methods-reference-only">4.5.3. Other Notable Methods (Reference Only)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-visualization-techniques">4.5.3.1. Advanced Visualization Techniques</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specialized-statistical-methods">4.5.3.2. Specialized Statistical Methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-learning-visualization">4.5.3.3. Machine Learning Visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-and-dynamic-methods">4.5.3.4. Interactive and Dynamic Methods</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="important admonition">
<p class="admonition-title">Remark</p>
<p>Please be aware that these lecture notes are accessible online in an ‘<strong>early access</strong>’ format. They are actively being developed, and certain sections will be further enriched to provide a comprehensive understanding of the subject matter.</p>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="time-series-outlier-detection-visual-methods">
<h1><span class="section-number">4.4. </span>Time Series Outlier Detection: Visual Methods<a class="headerlink" href="#time-series-outlier-detection-visual-methods" title="Link to this heading">#</a></h1>
<p>Before diving into complex statistical tests or machine learning models, the most effective first step in outlier detection is often the simplest: <strong>looking at your data</strong>.</p>
<p>Visual methods provide immediate intuition about the nature, location, and potential cause of anomalies—intuition that pure summary statistics often miss.</p>
<div class="important admonition">
<p class="admonition-title">Note</p>
<p>While visual methods are excellent for exploration and validation, they are <strong>subjective</strong>. They should typically be used to <em>identify</em> potential issues, which are then confirmed with the <strong>statistical methods</strong> discussed in Section XX.</p>
</div>
<section id="time-plots-line-plots">
<h2><span class="section-number">4.4.1. </span>Time Plots (Line Plots)<a class="headerlink" href="#time-plots-line-plots" title="Link to this heading">#</a></h2>
<p><strong>The “First Look”</strong></p>
<p>The line plot is your primary tool. It displays data chronologically, revealing the “flow” of history.</p>
<p><strong>What to look for:</strong></p>
<ul class="simple">
<li><p><strong>Spikes &amp; Dips:</strong> Sudden vertical jumps (Additive Outliers)</p></li>
<li><p><strong>Breaks:</strong> Visible shifts in the baseline level (Level Shifts)</p></li>
<li><p><strong>Pattern Disruptions:</strong> Interrupted seasonal cycles or volatility changes</p></li>
</ul>
<figure class="align-center" id="timeplot-outliers-illustration">
<a class="reference internal image-reference" href="../_images/timeplot_outliers_illustration.png"><img alt="../_images/timeplot_outliers_illustration.png" src="../_images/timeplot_outliers_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.12 </span><span class="caption-text">Time plot showing web traffic with three distinct anomaly types: a single-day spike (AO), a permanent level increase (LS), and a decaying impact surge (IO/TC).</span><a class="headerlink" href="#timeplot-outliers-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>Why it works:</strong></p>
<p>Our eyes naturally spot interruptions in continuity. A single point sticking out from a smooth line is immediately obvious, even if it doesn’t statistically break a global threshold.</p>
<p>In <a class="reference internal" href="#timeplot-outliers-illustration"><span class="std std-numref">Fig. 4.12</span></a>, three distinct anomalies are visible:</p>
<ol class="arabic simple">
<li><p><strong>AO (Additive Outlier):</strong> A sharp spike at day 60 that immediately returns to normal, suggesting a one-time event or error.</p></li>
<li><p><strong>LS (Level Shift):</strong> At day 140, the green dashed line marks a permanent jump in traffic baseline. The “new normal” is consistently higher.</p></li>
<li><p><strong>IO/TC (Decaying Impact):</strong> Starting around day 200, the purple shaded region shows a surge that slowly fades back down, suggesting a lingering effect like a marketing campaign.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 1: Time Plot (Line Plot): Visualizing Spikes, Shifts, and Decay in Web Traffic</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

<span class="c1"># 1) Synthetic daily traffic (~9 months)</span>
<span class="n">n_days</span> <span class="o">=</span> <span class="mi">270</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_days</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="c1"># Weekday/weekend pattern (weekends ~25% lower)</span>
<span class="n">weekday</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">dayofweek</span>
<span class="n">weekday_effect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">)</span>

<span class="c1"># Baseline with mild trend + small annual wave + noise</span>
<span class="n">trend</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_days</span><span class="p">)</span>
<span class="n">base</span> <span class="o">=</span> <span class="mi">800</span> <span class="o">*</span> <span class="n">weekday_effect</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_days</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># 2) Inject outlier types</span>
<span class="n">T_AO</span> <span class="o">=</span> <span class="mi">60</span>   <span class="c1"># Additive Outlier: single-day spike</span>
<span class="n">Y</span><span class="p">[</span><span class="n">T_AO</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">500</span>

<span class="n">T_LS</span> <span class="o">=</span> <span class="mi">140</span>  <span class="c1"># Level Shift: permanent upward change</span>
<span class="n">omega_ls</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">Y</span><span class="p">[</span><span class="n">T_LS</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">omega_ls</span>

<span class="n">T_IO</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># IO/TC: persistent decaying uplift</span>
<span class="n">omega_i</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">phi</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T_IO</span><span class="p">,</span> <span class="n">n_days</span><span class="p">):</span>
    <span class="n">Y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+=</span> <span class="n">omega_i</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">**</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">T_IO</span><span class="p">))</span>

<span class="c1"># 3) Save data</span>
<span class="n">viz_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;traffic&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">})</span>
<span class="n">viz_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_timeplot_outliers.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 4) Time plot with annotations</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">)</span>

<span class="c1"># AO marker</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_AO</span><span class="p">],</span> <span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_AO</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;AO: single-day spike&#39;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_AO</span><span class="p">],</span> <span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_AO</span><span class="p">]),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">28</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>

<span class="c1"># LS marker</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_LS</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;LS: persistent level increase&#39;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_LS</span><span class="p">],</span> <span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_LS</span><span class="p">]),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="c1"># IO/TC region with moving-median baseline as visual guide</span>
<span class="n">ma</span> <span class="o">=</span> <span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_IO</span><span class="p">:],</span> <span class="n">ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_IO</span><span class="p">:],</span> <span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_IO</span><span class="p">:],</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Decaying uplift region&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;IO/TC: decaying impact&#39;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_IO</span><span class="p">],</span> <span class="n">viz_df</span><span class="p">[</span><span class="s1">&#39;traffic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">T_IO</span><span class="p">]),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">26</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time Plot (Line Plot): Visualizing Spikes, Shifts, and Decay in Web Traffic&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Requests per day&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;timeplot_outliers_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="histograms">
<h2><span class="section-number">4.4.2. </span>Histograms<a class="headerlink" href="#histograms" title="Link to this heading">#</a></h2>
<p><strong>The “Shape” Check</strong></p>
<p>Histograms show the distribution of your data values, ignoring time. They answer: <em>“How common is this value?”</em></p>
<p><strong>What to look for:</strong></p>
<ul class="simple">
<li><p><strong>Isolated Bars:</strong> Small bars far from the main cluster (the “long tail”)</p></li>
<li><p><strong>Gaps:</strong> Empty space between the main distribution and extreme values</p></li>
<li><p><strong>Skewness:</strong> Long trails on one side indicating frequent positive or negative outliers</p></li>
</ul>
<figure class="align-center" id="temperature-histograms-illustration">
<a class="reference internal image-reference" href="../_images/temperature_histograms_illustration.png"><img alt="../_images/temperature_histograms_illustration.png" src="../_images/temperature_histograms_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.13 </span><span class="caption-text">Temperature distributions by season. The overall histogram mixes all temperatures, while seasonal breakdowns reveal context-specific outliers: anomalously cold days in summer and warm days in winter.</span><a class="headerlink" href="#temperature-histograms-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>Why it works:</strong></p>
<p>In a normal process, data tends to cluster around a central mean. Outliers violate this pattern, standing alone at the edges.</p>
<p>In <a class="reference internal" href="#temperature-histograms-illustration"><span class="std std-numref">Fig. 4.13</span></a>, temperature distributions are broken down by season:</p>
<ol class="arabic simple">
<li><p><strong>Overall (Left):</strong> The blue histogram shows a broad temperature mix. Outliers are hard to spot because cold and hot days blend together.</p></li>
<li><p><strong>Summer (Center):</strong> The orange histogram clusters tightly around high temperatures. Small bars on the far left (around 45°F) are isolated—anomalously cold days for July.</p></li>
<li><p><strong>Winter (Right):</strong> The teal histogram shows typical cold weather. Small bars on the far right (around 70°F) reveal unusually warm days for January.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 2: Histograms: Overall and Grouped (Summer vs Winter)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">909</span><span class="p">)</span>

<span class="c1"># 1) Daily temperatures for 3 years with seasonal baselines</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2022-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">month</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">month</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

<span class="n">seasonal_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span>
                <span class="mi">7</span><span class="p">:</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">38</span><span class="p">}</span>
<span class="n">seasonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">seasonal_map</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">month</span><span class="p">])</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seasonal</span> <span class="o">+</span> <span class="n">noise</span><span class="p">)</span>

<span class="c1"># Inject rare anomalies: cold July days and warm January days</span>
<span class="n">july_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">month</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">july_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">cold_july</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">july_idx</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">T</span><span class="p">[</span><span class="n">cold_july</span><span class="p">]</span> <span class="o">=</span> <span class="mf">45.0</span>  <span class="c1"># anomalously cold for July</span>

<span class="n">jan_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">month</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jan_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">warm_jan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">jan_idx</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">T</span><span class="p">[</span><span class="n">warm_jan</span><span class="p">]</span> <span class="o">=</span> <span class="mf">70.0</span>  <span class="c1"># anomalously warm for January</span>

<span class="c1"># DataFrame and CSV</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">month</span><span class="p">,</span> <span class="s1">&#39;temp_F&#39;</span><span class="p">:</span> <span class="n">T</span><span class="p">})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span> <span class="s1">&#39;Winter&#39;</span><span class="p">,</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]),</span> <span class="s1">&#39;Summer&#39;</span><span class="p">,</span> <span class="s1">&#39;Shoulder&#39;</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_temperature_histograms.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 2) Histograms: overall, summer, winter</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Overall histogram</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;temp_F&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Overall Temperature Distribution&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature (F)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Summer</span>
<span class="n">summer</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Summer&#39;</span><span class="p">][</span><span class="s1">&#39;temp_F&#39;</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">summer</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Summer (Jun–Aug)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature (F)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Winter</span>
<span class="n">winter</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Winter&#39;</span><span class="p">][</span><span class="s1">&#39;temp_F&#39;</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">winter</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Winter (Dec–Feb)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature (F)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Histograms: Overall and Grouped (Summer vs Winter)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;temperature_histograms_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="box-plots-box-and-whisker">
<h2><span class="section-number">4.4.3. </span>Box Plots (Box-and-Whisker)<a class="headerlink" href="#box-plots-box-and-whisker" title="Link to this heading">#</a></h2>
<p><strong>The “Summary” View</strong></p>
<p>Box plots display data distribution based on a five-number summary: minimum, Q1 (first quartile), median, Q3 (third quartile), and maximum.</p>
<p><strong>What to look for:</strong></p>
<ul class="simple">
<li><p><strong>Points beyond the whiskers:</strong> By convention, any point more than <strong>1.5 times the IQR</strong> (Interquartile Range) from the box is plotted as an individual dot—your prime outlier candidates.</p></li>
</ul>
<figure class="align-center" id="hourly-usage-boxplot-illustration">
<a class="reference internal image-reference" href="../_images/hourly_usage_boxplot_illustration.png"><img alt="../_images/hourly_usage_boxplot_illustration.png" src="../_images/hourly_usage_boxplot_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.14 </span><span class="caption-text">Hourly electricity usage box plots showing the daily cycle. Individual dots beyond whiskers represent days with unusually high usage for that specific hour, with a cluster of outliers highlighted at 3 AM.</span><a class="headerlink" href="#hourly-usage-boxplot-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>Why it works:</strong></p>
<p>Box plots automatically apply a statistical rule (the IQR method) to flag anomalies without manual calculations. They’re particularly powerful when comparing multiple groups (e.g., “Sales by Month”) side-by-side.</p>
<p><a class="reference internal" href="#hourly-usage-boxplot-illustration"><span class="std std-numref">Fig. 4.14</span></a> breaks down electricity usage by hour of the day:</p>
<ul class="simple">
<li><p><strong>The Boxes:</strong> Show the typical usage range for each hour. Notice the daily cycle: usage peaks around 6 PM (hour 18) and dips overnight.</p></li>
<li><p><strong>The Outliers (Dots):</strong> Individual black circles above boxes represent days with unusually high usage for that specific hour.</p></li>
<li><p><strong>Contextual Insight:</strong> The red arrow points to outliers at <strong>3 AM</strong>. While values around 20-30 kWh might be normal for 6 PM, they’re statistically extreme for 3 AM, flagging potential issues like equipment running overnight when it shouldn’t.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 3: Hourly Electricity Usage: Box Plots by Hour of Day</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">808</span><span class="p">)</span>

<span class="c1"># 1) 60 days of hourly electricity usage (kWh)</span>
<span class="n">periods</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-03-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
<span class="n">hour</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">hour</span>
<span class="n">weekday</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">dayofweek</span>  <span class="c1"># 0=Mon</span>

<span class="c1"># Diurnal pattern: peak ~6pm, lower overnight; weekdays slightly higher</span>
<span class="n">base</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">hour</span><span class="o">-</span><span class="mi">18</span><span class="p">)</span><span class="o">/</span><span class="mi">24</span><span class="p">)</span>
<span class="n">base</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">periods</span><span class="p">)</span>
<span class="n">usage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Contextual outliers: unusually high usage at 3 AM on some days</span>
<span class="n">three_am_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hour</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">three_am_indices</span><span class="p">[::</span><span class="mi">17</span><span class="p">]:</span>  <span class="c1"># every ~17th 3 AM</span>
    <span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">12.0</span>

<span class="c1"># Point outlier: extreme spike one evening</span>
<span class="n">usage</span><span class="p">[</span><span class="mi">24</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="mi">18</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">25.0</span>  <span class="c1"># ~day 20 at 6pm</span>

<span class="c1"># Dataset</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
    <span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="n">hour</span><span class="p">,</span>
    <span class="s1">&#39;weekday&#39;</span><span class="p">:</span> <span class="n">weekday</span><span class="p">,</span>
    <span class="s1">&#39;is_weekend&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">weekday</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
    <span class="s1">&#39;usage_kwh&#39;</span><span class="p">:</span> <span class="n">usage</span>
<span class="p">})</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_hourly_electricity.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 2) Box plots grouped by hour-of-day</span>
<span class="n">fig1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">hour_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">h</span><span class="p">][</span><span class="s1">&#39;usage_kwh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">)]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">hour_groups</span><span class="p">,</span> <span class="n">tick_labels</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">)],</span> <span class="n">showfliers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hourly Electricity Usage: Box Plots by Hour of Day&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Hour of Day&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Usage (kWh)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Annotate an example 3 AM outlier</span>
<span class="n">h3_vals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;usage_kwh&#39;</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;3 AM outlier (contextual)&#39;</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
             <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">h3_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>  <span class="c1"># boxplot positions start at 1</span>
             <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
             <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">),</span>
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>
<span class="n">fig1</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;hourly_usage_boxplot_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig1</span><span class="p">)</span>

<span class="c1"># # 3) Histograms: overall and grouped (weekday vs weekend)</span>
<span class="c1"># fig2, axes = plt.subplots(1, 3, figsize=(12, 5), sharey=True)</span>
<span class="c1"># # Overall</span>
<span class="c1"># axes[0].hist(df[&#39;usage_kwh&#39;], bins=30, color=&#39;steelblue&#39;, alpha=0.8, edgecolor=&#39;white&#39;)</span>
<span class="c1"># axes[0].set_title(&#39;Overall Usage Distribution&#39;)</span>
<span class="c1"># axes[0].set_xlabel(&#39;kWh&#39;)</span>
<span class="c1"># axes[0].set_ylabel(&#39;Frequency&#39;)</span>
<span class="c1"># axes[0].grid(True, alpha=0.3)</span>

<span class="c1"># # Weekdays</span>
<span class="c1"># wd = df[df[&#39;is_weekend&#39;]==0][&#39;usage_kwh&#39;]</span>
<span class="c1"># axes[1].hist(wd, bins=30, color=&#39;teal&#39;, alpha=0.8, edgecolor=&#39;white&#39;)</span>
<span class="c1"># axes[1].set_title(&#39;Weekdays&#39;)</span>
<span class="c1"># axes[1].set_xlabel(&#39;kWh&#39;)</span>
<span class="c1"># axes[1].grid(True, alpha=0.3)</span>

<span class="c1"># # Weekends</span>
<span class="c1"># we = df[df[&#39;is_weekend&#39;]==1][&#39;usage_kwh&#39;]</span>
<span class="c1"># axes[2].hist(we, bins=30, color=&#39;darkorange&#39;, alpha=0.8, edgecolor=&#39;white&#39;)</span>
<span class="c1"># axes[2].set_title(&#39;Weekends&#39;)</span>
<span class="c1"># axes[2].set_xlabel(&#39;kWh&#39;)</span>
<span class="c1"># axes[2].grid(True, alpha=0.3)</span>

<span class="c1"># fig2.suptitle(&#39;Histograms: Overall and Grouped (Weekday vs Weekend)&#39;, fontsize=16, weight = &#39;bold&#39;)</span>
<span class="c1"># fig2.tight_layout()</span>

<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="scatter-plots-lag-plots">
<h2><span class="section-number">4.4.4. </span>Scatter Plots (Lag Plots)<a class="headerlink" href="#scatter-plots-lag-plots" title="Link to this heading">#</a></h2>
<p><strong>The “Relationship” Check</strong></p>
<p>While standard scatter plots show relationships between two different variables, <strong>Lag Plots</strong> show the relationship between a data point and its own past values (e.g., (y_t) vs. (y_{t-1})).</p>
<p><strong>What to look for:</strong></p>
<ul class="simple">
<li><p><strong>The Main Cluster:</strong> Most points form a diagonal cloud (autocorrelation)</p></li>
<li><p><strong>The Rebels:</strong> Outliers appear far from this diagonal cloud, indicating a break in the temporal relationship</p></li>
</ul>
<figure class="align-center" id="scatter-plots-illustration">
<a class="reference internal image-reference" href="../_images/scatter_plots_illustration.png"><img alt="../_images/scatter_plots_illustration.png" src="../_images/scatter_plots_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.15 </span><span class="caption-text">Three scatter perspectives on monthly retail sales: time vs value reveals below-trend outliers, autocorrelation (lag plot) shows temporal consistency, and sales vs marketing spend identifies off-relationship points.</span><a class="headerlink" href="#scatter-plots-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>Why it works:</strong></p>
<p>Time series data usually has “inertia”—today is similar to yesterday. A point wildly different from yesterday violates this inertia and stands out clearly in 2D space.</p>
<p><a class="reference internal" href="#scatter-plots-illustration"><span class="std std-numref">Fig. 4.15</span></a> shows three scatter perspectives revealing different anomaly types:</p>
<ol class="arabic simple">
<li><p><strong>Time vs Value (Left):</strong> Monthly sales fitting a trend line. The red dot far below the orange trend line is an obvious “below-trend” outlier in December 2023.</p></li>
<li><p><strong>Autocorrelation (Center):</strong> This “Lag Plot” compares sales today vs. sales last month. Most points follow the diagonal line (good predictability). Outliers would appear far from this diagonal.</p></li>
<li><p><strong>Sales vs Spend (Right):</strong> Checks the relationship between marketing spend and sales. Typically, more spend = more sales. The red dot shows a month with high spend but low sales—an “off-relationship” point suggesting marketing inefficiency or external blockers.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 4: Scatter Plots: Time vs Value, Lagged, and Multi-variable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1111</span><span class="p">)</span>

<span class="c1"># 1) Monthly retail sales over 2019–2024</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2019-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">month</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

<span class="c1"># Seasonality (Q4 uplift) + trend + noise</span>
<span class="n">season_q</span> <span class="o">=</span> <span class="p">((</span><span class="n">months</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">season_mult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">season_q</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.03</span><span class="p">,</span> <span class="mf">1.07</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">])</span>
<span class="n">trend</span> <span class="o">=</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

<span class="n">sales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">season_mult</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">trend</span><span class="p">)</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Inject outlier: low Dec 2023 during peak</span>
<span class="n">mask_dec2023</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2023</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">months</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">where_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_dec2023</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_dec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">sales</span><span class="p">[</span><span class="n">where_dec</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales</span><span class="p">[</span><span class="n">where_dec</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>

<span class="c1"># Related series: marketing spend (correlated)</span>
<span class="n">spend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">season_mult</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">trend</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Data and lag</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;sales_m&#39;</span><span class="p">:</span> <span class="n">sales</span><span class="p">,</span> <span class="s1">&#39;spend_m&#39;</span><span class="p">:</span> <span class="n">spend</span><span class="p">})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_scatter_series.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Trend fit for time-value scatter</span>
<span class="n">X_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">reg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_time</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_time</span><span class="p">)</span>

<span class="c1"># 2) Scatter plots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># A) Time vs Value</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Monthly sales&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trend fit&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_dec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">didx</span> <span class="o">=</span> <span class="n">where_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">didx</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">didx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Below-trend outlier&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Below trend during</span><span class="se">\n</span><span class="s1">peak season&#39;</span><span class="p">,</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                     <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">didx</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">didx</span><span class="p">]),</span>
                     <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">130</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                     <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">),</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time vs Value (Sales)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sales (millions)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># B) Lag-1 scatter</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">,</span><span class="s1">&#39;lag1&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Autocorrelation Scatter (Lag 1)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$Sales_{t-1}$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$Sales_t$&#39;</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">p1</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xline</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xline</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># C) Sales vs Marketing Spend</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;spend_m&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#7a5cff&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sales vs Marketing Spend&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Marketing spend (millions)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sales (millions)&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_dec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;spend_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">didx</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">didx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Off-relationship point&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Off-relationship</span><span class="se">\n</span><span class="s1">point (Dec 2023)&#39;</span><span class="p">,</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                     <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;spend_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">didx</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">didx</span><span class="p">]),</span>
                     <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                     <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">),</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Scatter Plots: Time vs Value, Lagged, and Multi-variable&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">.03</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;scatter_plots_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><font color='Blue'><b>Example:</b></font> Stock price lag plots typically show points clustering along a diagonal line (today’s price correlates with yesterday’s). A point far below this line might indicate a flash crash; points far above suggest unusual price jumps.</p>
<p><strong>Lag-1 vs Lag-7 comparison:</strong></p>
<figure class="align-center" id="lag-plots-illustration">
<a class="reference internal image-reference" href="../_images/lag_plots_illustration.png"><img alt="../_images/lag_plots_illustration.png" src="../_images/lag_plots_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.16 </span><span class="caption-text">Lag plots comparing temporal dependence. Lag-1 shows strong correlation with a highlighted point outlier (flash crash), while Lag-7 reveals a high-variance regime cluster indicating structural change.</span><a class="headerlink" href="#lag-plots-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>What it shows:</strong></p>
<ul class="simple">
<li><p><strong>Lag 1:</strong> Points align along a linear trend due to AR(1) correlation; an isolated red point illustrates a point outlier breaking the relationship.</p></li>
<li><p><strong>Lag 7:</strong> The purple cluster shows wider spread, indicating structural variance change and pattern disruption relative to earlier points.</p></li>
</ul>
<p><strong>How to interpret:</strong></p>
<ul class="simple">
<li><p>Lag-1 captures immediate temporal dependence; outliers appear far from the main diagonal cluster.</p></li>
<li><p>Comparing Lag-1 vs Lag-7 reveals different temporal structures; increased spread at Lag-7 after a regime change indicates structural shifts or volatility clustering.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 5: Lag Plots: Outliers, Structural Variance Change, and Pattern Disruption</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">606</span><span class="p">)</span>

<span class="c1"># 1) Synthetic AR(1)-like series (n=400)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">phi</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">Y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">*</span> <span class="n">Y</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

<span class="c1"># Structural variance increase after t=250</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">251</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">Y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">*</span> <span class="n">Y</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Point outliers (flash crash / jump)</span>
<span class="n">Y</span><span class="p">[</span><span class="mi">120</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">6.0</span>
<span class="n">Y</span><span class="p">[</span><span class="mi">265</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">7.5</span>

<span class="c1"># Data and lags</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;lag7&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

<span class="n">p1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;lag1&#39;</span><span class="p">])</span>
<span class="n">p7</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;lag7&#39;</span><span class="p">])</span>

<span class="c1"># 2) Lag-1 and Lag-7 plots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Lag-1: correlation and point outlier</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Lag Plot ($k=1$): $Y_t$ vs $Y_{t-1}$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$Y_{t-1}$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$Y_t$&#39;</span><span class="p">)</span>

<span class="c1"># Highlight a point outlier</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">120</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Point outlier&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Flash crash / jump&#39;</span><span class="p">,</span>
                 <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span>
                 <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                 <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                 <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">),</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>

<span class="c1"># Reference OLS fit line</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">p1</span><span class="p">[</span><span class="s1">&#39;lag1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xline</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xline</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;OLS fit&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># Lag-7: pattern disruption/variance change</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p7</span><span class="p">[</span><span class="s1">&#39;lag7&#39;</span><span class="p">],</span> <span class="n">p7</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Lag Plot ($k=7$): $Y_t$ vs $Y_{t-7}$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$Y_{t-7}$&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$Y_t$&#39;</span><span class="p">)</span>

<span class="c1"># Highlight high-variance regime cluster</span>
<span class="n">post_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">260</span><span class="p">)</span>
<span class="n">post</span> <span class="o">=</span> <span class="n">p7</span><span class="p">[</span><span class="n">p7</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">post_mask</span><span class="p">])]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s1">&#39;lag7&#39;</span><span class="p">],</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High-variance regime&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Lag Plots: Outliers, Structural Variance Change, and Pattern Disruption&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save underlying series</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_lagplot_series.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;lag_plots_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="violin-plots-grouped-by-time-unit">
<h2><span class="section-number">4.4.5. </span>Violin Plots (Grouped by Time Unit)<a class="headerlink" href="#violin-plots-grouped-by-time-unit" title="Link to this heading">#</a></h2>
<p><strong>Purpose:</strong> Provides a richer view of data distribution density compared to box plots, grouped by cyclical time units.</p>
<p><strong>How it Works:</strong> Groups data by time units (hour of day, day of week, month) to show how distributions vary cyclically. The “violin” shape shows the density of data points at different value levels.</p>
<p><strong>Outlier Detection:</strong></p>
<ul class="simple">
<li><p>Outliers appear as points far from the main “body” or “density” of the violin shape</p></li>
<li><p>Particularly useful for seasonal data where normal ranges change with seasons</p></li>
<li><p>Detects values that are extreme for specific time periods</p></li>
</ul>
<p><strong>Example:</strong> Monthly sales data grouped by quarter, where Q4 typically shows higher sales due to holidays. An unusually low December sales figure would appear as an outlier far from the dense part of the Q4 violin, even if it might be normal for other quarters.</p>
<figure class="align-center" id="quarterly-sales-violin-illustration">
<a class="reference internal image-reference" href="../_images/quarterly_sales_violin_illustration.png"><img alt="../_images/quarterly_sales_violin_illustration.png" src="../_images/quarterly_sales_violin_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.17 </span><span class="caption-text">Violin plot showing quarterly sales distribution densities. The Q4 violin is wider and centered higher than other quarters, but an unusually low December 2024 point appears far from the Q4 density, revealing a contextual outlier.</span><a class="headerlink" href="#quarterly-sales-violin-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 6: Violin Plot by Quarter: Distribution Density across Cyclical Time Units</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">505</span><span class="p">)</span>

<span class="c1"># 1) 4 years of monthly sales with Q4 uplift</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">month</span>
<span class="n">years</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">year</span>

<span class="c1"># Base and seasonal uplift (millions USD)</span>
<span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
<span class="n">quarter</span> <span class="o">=</span> <span class="p">((</span><span class="n">months</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">q_multiplier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">quarter</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.10</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">])</span>  <span class="c1"># Q4 highest</span>
<span class="n">trend</span> <span class="o">=</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="p">(</span><span class="n">years</span> <span class="o">-</span> <span class="n">years</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>  <span class="c1"># mild YoY growth</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="n">sales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">base</span> <span class="o">*</span> <span class="n">q_multiplier</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">trend</span><span class="p">)</span> <span class="o">+</span> <span class="n">noise</span><span class="p">)</span>
<span class="n">sales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Inject outlier: low December 2024</span>
<span class="n">mask_dec24</span> <span class="o">=</span> <span class="p">(</span><span class="n">years</span> <span class="o">==</span> <span class="mi">2024</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">months</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">sales</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_dec24</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.65</span>

<span class="c1"># DataFrame and CSV</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">years</span><span class="p">,</span>
    <span class="s1">&#39;mon&#39;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span>
    <span class="s1">&#39;quarter&#39;</span><span class="p">:</span> <span class="n">quarter</span><span class="p">,</span>
    <span class="s1">&#39;sales_millions&#39;</span><span class="p">:</span> <span class="n">sales</span>
<span class="p">})</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_quarterly_violin_sales.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 2) Violin plot grouped by quarter</span>
<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;quarter&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;sales_millions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Q1&#39;</span><span class="p">,</span><span class="s1">&#39;Q2&#39;</span><span class="p">,</span><span class="s1">&#39;Q3&#39;</span><span class="p">,</span><span class="s1">&#39;Q4&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">parts</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showextrema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showmedians</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Style violins and summary lines</span>
<span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="s1">&#39;bodies&#39;</span><span class="p">]:</span>
    <span class="n">pc</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;#6baed6&#39;</span><span class="p">)</span>
    <span class="n">pc</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;#377eb8&#39;</span><span class="p">)</span>
    <span class="n">pc</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;cbars&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="s1">&#39;cbars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;#444444&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;cmins&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="s1">&#39;cmins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;#444444&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;cmaxes&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="s1">&#39;cmaxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;#444444&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;cmeans&#39;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="s1">&#39;cmeans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;#e6550d&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sales (USD, millions)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Violin Plot by Quarter: Distribution Density across Cyclical Time Units&#39;</span><span class="p">)</span>

<span class="c1"># 3) Overlay jittered monthly points and highlight Dec 2024</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;quarter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sales_millions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">jitter</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#4d4d4d&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Monthly points&#39;</span><span class="p">)</span>

<span class="n">dec_val</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_dec24</span><span class="p">,</span> <span class="s1">&#39;sales_millions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">dec_val</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Low Dec 2024 (Q4)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Unusually low Dec 2024 within Q4&#39;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">dec_val</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">280</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;quarterly_sales_violin_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="seasonal-decomposition-plots">
<h2><span class="section-number">4.4.6. </span>Seasonal Decomposition Plots<a class="headerlink" href="#seasonal-decomposition-plots" title="Link to this heading">#</a></h2>
<p><strong>The “X-Ray” Vision</strong></p>
<p>Sometimes outliers are hidden by strong seasonal patterns. Decomposition splits your series into three parts: <strong>Trend</strong>, <strong>Seasonality</strong>, and <strong>Residuals</strong> (Noise).</p>
<p><strong>What to look for:</strong></p>
<ul class="simple">
<li><p><strong>The Residual Plot:</strong> This is where the magic happens. After removing trend and season, what’s left is pure noise.</p></li>
<li><p><strong>Spikes in Residuals:</strong> A huge spike in the residual plot that wasn’t obvious in the original data is a clear anomaly—it means the value cannot be explained by trend or season.</p></li>
</ul>
<figure class="align-center" id="seasonal-decomposition-illustration">
<a class="reference internal image-reference" href="../_images/stl_decomposition_icecream_sales_illustration.png"><img alt="../_images/stl_decomposition_icecream_sales_illustration.png" src="../_images/stl_decomposition_icecream_sales_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.18 </span><span class="caption-text">STL decomposition of ice cream sales separating observed data into trend, seasonal, and residual components. The residual panel reveals a massive January 2023 spike invisible in the raw data—an unseasonable anomaly.</span><a class="headerlink" href="#seasonal-decomposition-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>Why it works:</strong></p>
<p>Decomposition strips away the “distractions” of normal daily or yearly cycles, leaving anomalies exposed. A value of 100 might look normal in December, but if the seasonal model expects 95, the residual is only 5. If the model expects 10, the residual is 90—a massive outlier.</p>
<p>The decomposition in <a class="reference internal" href="#seasonal-decomposition-illustration"><span class="std std-numref">Fig. 4.18</span></a> breaks ice cream sales data into four panels:</p>
<ol class="arabic simple">
<li><p><strong>Observed (Top):</strong> The raw data, wiggly and hard to read perfectly.</p></li>
<li><p><strong>Trend:</strong> Shows smooth, long-term growth.</p></li>
<li><p><strong>Seasonal:</strong> Shows the repeating annual wave pattern.</p></li>
<li><p><strong>Residual (Bottom):</strong> The most important panel. The red circle highlights a massive spike in <strong>January 2023</strong>. This is a “residual outlier”—a value that defies the model’s prediction. Since January is usually a low month, this unseasonable spike demands investigation (perhaps a warm winter or data error).</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 7: STL Decomposition: Trend, Seasonality, and Residuals with Outlier Highlight</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tsa.seasonal</span><span class="w"> </span><span class="kn">import</span> <span class="n">STL</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">732</span><span class="p">)</span>

<span class="c1"># 1) Monthly ice cream sales: 2019–2024 with summer seasonality and trend</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2019-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">month</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

<span class="n">trend</span> <span class="o">=</span> <span class="mf">0.18</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>                         <span class="c1"># gradual growth</span>
<span class="n">season</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">months</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>   <span class="c1"># peak ~June/July</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

<span class="n">sales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">25</span> <span class="o">+</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">season</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Inject unusual January spike (Jan 2023)</span>
<span class="n">jan_2023_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">months</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2023</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jan_2023_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">jan_2023_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sales</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">10.0</span>

<span class="c1"># 2) STL decomposition (monthly period=12)</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sales</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
<span class="n">stl</span> <span class="o">=</span> <span class="n">STL</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">stl</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># 3) Save components</span>
<span class="n">comp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
    <span class="s1">&#39;observed&#39;</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">trend</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;seasonal&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">seasonal</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;resid&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">values</span>
<span class="p">})</span>
<span class="n">comp_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_stl_icecream_sales_v2.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 4) Plot panels and highlight residual spike</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;observed&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trend&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Seasonal&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;resid&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#666&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual (Inspect for Outliers)&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jan_2023_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">jan_2023_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;resid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residual spike (Jan 2023)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Unusual residual after</span><span class="se">\n</span><span class="s1">removing trend/seasonality&#39;</span><span class="p">,</span>
                     <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">comp_df</span><span class="p">[</span><span class="s1">&#39;resid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span>
                     <span class="n">fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">},</span>
                     <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                     <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">),</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Robust Seasonal Decomposition (STL): Trend, Seasonality, and Residuals&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.970</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;stl_decomposition_icecream_sales_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="q-q-plots-quantile-quantile-plots">
<h2><span class="section-number">4.4.7. </span>Q-Q Plots (Quantile-Quantile Plots)<a class="headerlink" href="#q-q-plots-quantile-quantile-plots" title="Link to this heading">#</a></h2>
<p><strong>Purpose:</strong> Compares data distribution quantiles against theoretical distribution quantiles (typically normal distribution).</p>
<p><strong>How it Works:</strong> Plots sample quantiles vs theoretical quantiles to assess distributional assumptions and identify extreme values.</p>
<p><strong>Outlier Detection:</strong></p>
<ul class="simple">
<li><p><strong>Heavy Tails/Skewness:</strong> Deviations from the straight line at plot extremes indicate distribution departures caused by outliers</p></li>
<li><p><strong>Extreme Points:</strong> Individual points falling far from the main line, especially at tails, strongly suggest outliers deviating from the assumed theoretical distribution</p></li>
</ul>
<p><strong>Example:</strong> Daily temperature readings plotted against the normal distribution. Most points follow the diagonal line, but a few points at the extreme ends (representing unusually hot or cold days) deviate significantly, indicating potential weather anomalies or measurement errors.</p>
<figure class="align-center" id="qq-plot-temperature-illustration">
<a class="reference internal image-reference" href="../_images/qq_plot_temperature_illustration.png"><img alt="../_images/qq_plot_temperature_illustration.png" src="../_images/qq_plot_temperature_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.19 </span><span class="caption-text">Q-Q plot of daily temperatures vs normal quantiles. Most points align with the reference line, but tail deviations (highlighted in red) reveal extreme hot and cold days departing from normality.</span><a class="headerlink" href="#qq-plot-temperature-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>What it shows:</strong></p>
<p>Deviations from the reference line at the extremes indicate heavy tails or skewness, often driven by outliers. Highlighted tail points represent extreme observations (very hot/cold days) that depart from the assumed normal model.</p>
<p><strong>How to present:</strong></p>
<p>Point to the straight-line fit as the normality reference; departures at ends suggest heavy tails or skewness. Emphasize that extreme tail points often correspond to actual anomalous events or measurement errors in the underlying series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 8: Q-Q Plot: Assessing Normality of Daily Temperatures with Tail Highlights</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">stats</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1010</span><span class="p">)</span>

<span class="c1"># 1) Two years of daily temperatures with seasonal baselines</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2023-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">month</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">month</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

<span class="n">seasonal_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span>
                <span class="mi">7</span><span class="p">:</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">38</span><span class="p">}</span>
<span class="n">seasonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">seasonal_map</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">month</span><span class="p">])</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seasonal</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Inject extremes: very hot summer days and very cold winter days</span>
<span class="n">hot_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">month</span><span class="o">==</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">month</span><span class="o">==</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">T</span><span class="p">[</span><span class="n">hot_days</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">20.0</span>
<span class="n">cold_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">month</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">month</span><span class="o">==</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">T</span><span class="p">[</span><span class="n">cold_days</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">20.0</span>

<span class="n">qq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;temp_F&#39;</span><span class="p">:</span> <span class="n">T</span><span class="p">})</span>
<span class="n">qq_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_temperature_for_qq.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 2) Q-Q plot against Normal</span>
<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">qq_df</span><span class="p">[</span><span class="s1">&#39;temp_F&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">qq_df</span><span class="p">[</span><span class="s1">&#39;temp_F&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">qq_df</span><span class="p">[</span><span class="s1">&#39;temp_F&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="n">theoretical_q</span><span class="p">,</span> <span class="n">ordered_sample</span><span class="p">),</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theoretical_q</span><span class="p">,</span> <span class="n">ordered_sample</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sample quantiles&#39;</span><span class="p">)</span>

<span class="c1"># Reference line</span>
<span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">theoretical_q</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">theoretical_q</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xline</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span><span class="o">*</span><span class="n">xline</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference line&#39;</span><span class="p">)</span>

<span class="c1"># Highlight extreme tails (top/bottom 1%)</span>
<span class="n">mask_tails</span> <span class="o">=</span> <span class="p">(</span><span class="n">theoretical_q</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">theoretical_q</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">theoretical_q</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">theoretical_q</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">theoretical_q</span><span class="p">[</span><span class="n">mask_tails</span><span class="p">],</span> <span class="n">ordered_sample</span><span class="p">[</span><span class="n">mask_tails</span><span class="p">],</span>
           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tail deviations&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot: Daily Temperatures vs Normal Quantiles&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Theoretical Quantiles (Normal)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sample Quantiles (Standardized)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;qq_plot_temperature_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="normal-probability-plots-alternative-to-q-q-plots">
<h2><span class="section-number">4.4.8. </span>Normal Probability Plots (Alternative to Q-Q Plots)<a class="headerlink" href="#normal-probability-plots-alternative-to-q-q-plots" title="Link to this heading">#</a></h2>
<p><strong>Purpose:</strong> Specifically tests normality assumption by plotting ordered data against expected normal quantiles.</p>
<p><strong>How it Works:</strong></p>
<ul class="simple">
<li><p>Order observations from smallest to largest</p></li>
<li><p>Plot against expected values from standard normal distribution</p></li>
<li><p>Assess linearity of the relationship</p></li>
</ul>
<p><strong>Outlier Detection:</strong></p>
<ul class="simple">
<li><p><strong>Tail Deviations:</strong> Points curving away from straight line at extremes</p></li>
<li><p><strong>Individual Outliers:</strong> Specific points jumping off the main linear pattern</p></li>
<li><p><strong>Distribution Assessment:</strong> Overall pattern reveals if outliers are causing non-normality</p></li>
</ul>
<p><font color='Blue'><b>Example:</b></font> Processing time data for manufacturing operations. Most points follow a straight line on the normal probability plot, but a few points at the upper end curve dramatically upward, indicating occasional severe delays that represent process outliers.</p>
<figure class="align-center" id="normal-probability-plot-processing-times-illustration">
<a class="reference internal image-reference" href="../_images/normal_probability_plot_processing_times_illustration.png"><img alt="../_images/normal_probability_plot_processing_times_illustration.png" src="../_images/normal_probability_plot_processing_times_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.20 </span><span class="caption-text">Normal probability plot of manufacturing processing times. The central fit shows linearity, but upper-tail points curve upward, revealing severe delays that break normality assumptions.</span><a class="headerlink" href="#normal-probability-plot-processing-times-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>What it shows:</strong></p>
<p>Ordered data vs expected normal quantiles should align along a straight line if normally distributed; curvature at tails signals non-normality such as heavy tails or skewness. Highlighted extreme upper-tail points represent individual outliers (severe delays) jumping off the main linear pattern.</p>
<p><strong>How to present:</strong></p>
<p>Tail deviations—curvature or separation at the extremes—indicate heavy tails or skewness impacting normality. Individual outliers (points far from the reference line, especially in the upper tail) correspond to severe process delays worth investigating.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 9: Normal Probability Plot: Processing Times with Right Skew and Severe Delays</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">stats</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1212</span><span class="p">)</span>

<span class="c1"># 1) Simulate processing times with mild right skew + injected severe delays</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">skew_component</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.25</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">proc_time</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">skew_component</span>

<span class="c1"># Inject upper-tail outliers (severe delays)</span>
<span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">proc_time</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">20</span>   <span class="c1"># large delays</span>
<span class="n">proc_time</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]</span> <span class="o">+=</span> <span class="mi">30</span>   <span class="c1"># even larger delays</span>

<span class="c1"># Save dataset</span>
<span class="n">np_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;proc_time_min&#39;</span><span class="p">:</span> <span class="n">proc_time</span><span class="p">})</span>
<span class="n">np_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_processing_times.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 2) Normal Probability Plot</span>
<span class="c1"># Order observations</span>
<span class="n">ordered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">proc_time</span><span class="p">)</span>
<span class="c1"># Expected normal quantiles for plotting positions (i - 0.5)/n</span>
<span class="n">ppoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
<span class="n">expected</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">ppoints</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ordered data vs normal quantiles&#39;</span><span class="p">)</span>

<span class="c1"># Fit a reference line using central 10%..90% to avoid tail influence</span>
<span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.10</span><span class="o">*</span><span class="n">n</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.90</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="n">lin</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="n">lo</span><span class="p">:</span><span class="n">hi</span><span class="p">],</span> <span class="n">ordered</span><span class="p">[</span><span class="n">lo</span><span class="p">:</span><span class="n">hi</span><span class="p">])</span>
<span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">lin</span><span class="o">.</span><span class="n">slope</span><span class="p">,</span> <span class="n">lin</span><span class="o">.</span><span class="n">intercept</span>
<span class="n">xline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">expected</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xline</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span><span class="o">*</span><span class="n">xline</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference line (central fit)&#39;</span><span class="p">)</span>

<span class="c1"># Highlight extreme upper-tail deviations (potential outliers)</span>
<span class="n">upper_mask</span> <span class="o">=</span> <span class="n">expected</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="n">upper_mask</span><span class="p">],</span> <span class="n">ordered</span><span class="p">[</span><span class="n">upper_mask</span><span class="p">],</span>
           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Upper-tail deviations&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normal Probability Plot: Processing Times vs Expected Normal Quantiles&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Expected Normal Quantiles&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Ordered Processing Times (min)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;normal_probability_plot_processing_times_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="residual-plots">
<h2><span class="section-number">4.4.9. </span>Residual Plots<a class="headerlink" href="#residual-plots" title="Link to this heading">#</a></h2>
<p><strong>Purpose:</strong> After fitting a model (trend, seasonal, or regression), residuals show unexplained variations that may indicate outliers.</p>
<p><strong>How it Works:</strong></p>
<ul class="simple">
<li><p>Fit appropriate model to time series (linear trend, seasonal model, ARIMA, etc.)</p></li>
<li><p>Calculate residuals: difference between observed and predicted values</p></li>
<li><p>Plot residuals against time, fitted values, or other variables</p></li>
</ul>
<p><strong>Outlier Detection:</strong></p>
<ul class="simple">
<li><p><strong>Large Residuals:</strong> Points with residuals exceeding 2-3 standard deviations from zero</p></li>
<li><p><strong>Patterns in Residuals:</strong> Non-random patterns suggesting model inadequacy or outlier influence</p></li>
<li><p><strong>Heteroscedasticity:</strong> Changing variance in residuals over time, possibly due to outliers</p></li>
<li><p><strong>Autocorrelation:</strong> Residual patterns indicating temporal outliers affecting model fit</p></li>
</ul>
<p><strong>Example:</strong> After fitting a seasonal trend model to monthly airline passenger data, most residuals cluster around zero. A residual of +500 passengers in a typically low-travel month would stand out dramatically, potentially indicating a special event, data error, or external factor like a fare promotion.</p>
<figure class="align-center" id="residual-diagnostics-illustration">
<a class="reference internal image-reference" href="../_images/residual_diagnostics_illustration.png"><img alt="../_images/residual_diagnostics_illustration.png" src="../_images/residual_diagnostics_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.21 </span><span class="caption-text">Residual diagnostic plots after fitting a seasonal trend model. The time plot reveals a +700 passenger residual in February 2022 beyond ±2SD thresholds, while the fitted plot checks for heteroscedasticity.</span><a class="headerlink" href="#residual-diagnostics-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>What it shows:</strong></p>
<ul class="simple">
<li><p><strong>Large residuals:</strong> A +700 residual in a low month stands out beyond ±2–3 SD lines, flagging a candidate outlier for investigation.</p></li>
<li><p><strong>Patterns:</strong> Residuals vs fitted checks for structure or heteroscedasticity; non-random shapes suggest model inadequacy or outlier influence.</p></li>
<li><p><strong>Standardized residuals:</strong> Threshold lines at ±2 and ±3 SD provide a quick statistical screen for extreme points.</p></li>
</ul>
<p><strong>How to present:</strong></p>
<p>Large residuals beyond ±2–3 SD are prime candidates; verify if they align with known events, promotions, or data issues. If residual vs fitted shows funneling or curves, consider variance-stabilizing transforms or richer seasonality; persistent time patterns suggest model refinement or outliers clustered in certain periods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 10: Residual Diagnostics: Time, Fitted, and Standardized with Thresholds</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1313</span><span class="p">)</span>

<span class="c1"># 1) Monthly series with trend + seasonality + noise, plus injected anomaly</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2019-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">month</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

<span class="n">trend</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">season</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">months</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">10000</span> <span class="o">+</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">season</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Inject a large positive residual in Feb 2022</span>
<span class="n">where_feb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">idx</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2022</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">months</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_feb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">obs</span><span class="p">[</span><span class="n">where_feb</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">where_feb</span><span class="p">]</span> <span class="o">+</span> <span class="mi">700</span>

<span class="c1"># 2) Seasonal-trend regression: const + time + 11 month dummies</span>
<span class="n">const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">month_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">const</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">month_dummies</span><span class="p">])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">fitted</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fittedvalues</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">resid</span>
<span class="n">std_resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">resid</span> <span class="o">-</span> <span class="n">resid</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Save</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
    <span class="s1">&#39;observed&#39;</span><span class="p">:</span> <span class="n">obs</span><span class="p">,</span>
    <span class="s1">&#39;fitted&#39;</span><span class="p">:</span> <span class="n">fitted</span><span class="p">,</span>
    <span class="s1">&#39;residual&#39;</span><span class="p">:</span> <span class="n">resid</span><span class="p">,</span>
    <span class="s1">&#39;std_residual&#39;</span><span class="p">:</span> <span class="n">std_resid</span>
<span class="p">})</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_residuals_airline_like.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 3) Residual diagnostics</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">))</span>

<span class="c1"># A) Residuals vs time</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#666&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals vs Time&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residual (obs - fitted)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Highlight Feb 2022 residual</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_feb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">where_feb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;+700 passengers</span><span class="se">\n</span><span class="s1">residual (Feb 2022)&#39;</span><span class="p">,</span>
                     <span class="n">fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">},</span>
                     <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                     <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">64</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                     <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">),</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>

<span class="c1"># B) Residuals vs fitted</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;fitted&#39;</span><span class="p">],</span> <span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#666&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals vs Fitted&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fitted values&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># C) Standardized residuals with thresholds</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;std_residual&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#7a5cff&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#666&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;±2 SD&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;±3 SD&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Standardized Residuals (Thresholds)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Std residual&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Residual Plots: Time, Fitted, and Standardized Thresholds&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">.97</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;residual_diagnostics_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="control-charts-statistical-process-control">
<h2><span class="section-number">4.4.10. </span>Control Charts (Statistical Process Control)<a class="headerlink" href="#control-charts-statistical-process-control" title="Link to this heading">#</a></h2>
<p><strong>Purpose:</strong> Monitor process stability over time using statistical control limits based on historical data.</p>
<p><strong>How it Works:</strong></p>
<ul class="simple">
<li><p>Calculate center line (mean) and control limits (typically ±3σ)</p></li>
<li><p>Plot consecutive observations against time</p></li>
<li><p>Apply Western Electric rules for pattern detection</p></li>
</ul>
<p><strong>Outlier Detection:</strong></p>
<ul class="simple">
<li><p><strong>Points Beyond Control Limits:</strong> Individual observations outside ±3σ limits</p></li>
<li><p><strong>Run Patterns:</strong> Sequences of points on one side of center line</p></li>
<li><p><strong>Trend Patterns:</strong> Consecutive increasing or decreasing points</p></li>
<li><p><strong>Cycling Patterns:</strong> Regular oscillations indicating special causes</p></li>
</ul>
<p><strong>Example:</strong> Daily call center response times with established control limits based on historical performance. A single day with response time above the upper control limit would flag as an outlier, potentially indicating staffing issues or system problems.</p>
<figure class="align-center" id="individuals-control-chart-illustration">
<a class="reference internal image-reference" href="../_images/individuals_control_chart_illustration.png"><img alt="../_images/individuals_control_chart_illustration.png" src="../_images/individuals_control_chart_illustration.png" style="width: 900px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 4.22 </span><span class="caption-text">Individuals control chart (X-chart) with ±3σ limits. A point beyond the upper control limit is flagged, along with shaded regions illustrating pattern rules like trend and run sequences.</span><a class="headerlink" href="#individuals-control-chart-illustration" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p><strong>What it shows:</strong></p>
<p>Points beyond ±3σ are flagged as out-of-control observations, indicating potential special-cause issues like staffing or system incidents. Shaded regions illustrate pattern rules: a short consecutive trend and a sequence below the center line as run/trend cues.</p>
<p><strong>How to present:</strong></p>
<p>Points beyond ±3σ are immediate outliers; pair with run and trend rules to detect subtler special-cause signals. Emphasize Phase I vs Phase II: establish limits from a stable period, then monitor new data for out-of-control behavior.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 11: Individuals Control Chart (X) with ±3σ Limits and Pattern Cues</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1414</span><span class="p">)</span>

<span class="c1"># 1) Daily response times (minutes), 200 days</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="c1"># Stable process ~8 min with mild weekday effect + noise</span>
<span class="n">weekday</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">dayofweek</span>
<span class="n">baseline</span> <span class="o">=</span> <span class="mf">8.0</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">*</span><span class="p">(</span><span class="n">weekday</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">rt</span> <span class="o">=</span> <span class="n">baseline</span> <span class="o">+</span> <span class="n">noise</span>

<span class="c1"># Special-cause injections</span>
<span class="n">rt</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">4.0</span>                <span class="c1"># single high outlier (beyond UCL)</span>
<span class="n">rt</span><span class="p">[</span><span class="mi">120</span><span class="p">:</span><span class="mi">125</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># short upward trend</span>
<span class="n">rt</span><span class="p">[</span><span class="mi">160</span><span class="p">:</span><span class="mi">168</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.8</span>                        <span class="c1"># run of lower values</span>

<span class="c1"># 2) Phase I limits (first 50 days)</span>
<span class="n">phase1</span> <span class="o">=</span> <span class="n">rt</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span>
<span class="n">CL</span> <span class="o">=</span> <span class="n">phase1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">phase1</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">UCL</span> <span class="o">=</span> <span class="n">CL</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">sigma</span>
<span class="n">LCL</span> <span class="o">=</span> <span class="n">CL</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">sigma</span>

<span class="c1"># Western Electric Rule 1: beyond ±3σ</span>
<span class="n">beyond_limits</span> <span class="o">=</span> <span class="p">(</span><span class="n">rt</span> <span class="o">&gt;</span> <span class="n">UCL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rt</span> <span class="o">&lt;</span> <span class="n">LCL</span><span class="p">)</span>

<span class="c1"># Simple run detection: longest run above/below CL</span>
<span class="k">def</span><span class="w"> </span><span class="nf">longest_run_above_below</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">):</span>
    <span class="n">run_above</span> <span class="o">=</span> <span class="n">run_below</span> <span class="o">=</span> <span class="n">longest_above</span> <span class="o">=</span> <span class="n">longest_below</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">center</span><span class="p">:</span>
            <span class="n">run_above</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">run_below</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">center</span><span class="p">:</span>
            <span class="n">run_below</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">run_above</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_above</span> <span class="o">=</span> <span class="n">run_below</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">longest_above</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">longest_above</span><span class="p">,</span> <span class="n">run_above</span><span class="p">)</span>
        <span class="n">longest_below</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">longest_below</span><span class="p">,</span> <span class="n">run_below</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">longest_above</span><span class="p">,</span> <span class="n">longest_below</span>

<span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">longest_run_above_below</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">CL</span><span class="p">)</span>
<span class="n">run_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">la</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lb</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>

<span class="c1"># Simple trend rule: 6 consecutive increases or decreases</span>
<span class="k">def</span><span class="w"> </span><span class="nf">has_trend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">inc</span> <span class="o">=</span> <span class="n">dec</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">inc</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dec</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">dec</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">inc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inc</span> <span class="o">=</span> <span class="n">dec</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">inc</span> <span class="o">&gt;=</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">dec</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="n">trend_flag</span> <span class="o">=</span> <span class="n">has_trend</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="c1"># 3) Control chart</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Daily response time&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">CL</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>  <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Center line (CL)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">UCL</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;UCL (+3σ)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">LCL</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LCL (-3σ)&#39;</span><span class="p">)</span>

<span class="c1"># Highlight out-of-control points</span>
<span class="k">if</span> <span class="n">beyond_limits</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">beyond_limits</span><span class="p">],</span> <span class="n">rt</span><span class="p">[</span><span class="n">beyond_limits</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Beyond control limits&#39;</span><span class="p">)</span>

<span class="c1"># Shade Phase I used for limits</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">49</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Phase I (limits baseline)&#39;</span><span class="p">)</span>

<span class="c1"># Annotate example patterns</span>
<span class="k">if</span> <span class="n">trend_flag</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">120</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">124</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Trend pattern (example)&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">run_flag</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">160</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">167</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Run pattern (example)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Individuals Control Chart (X) with ±3σ Limits and Pattern Cues&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Response time (minutes)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save underlying data and limits</span>
<span class="n">cc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;response_time_min&#39;</span><span class="p">:</span> <span class="n">rt</span><span class="p">})</span>
<span class="n">cc_df</span><span class="p">[</span><span class="s1">&#39;CL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CL</span><span class="p">;</span> <span class="n">cc_df</span><span class="p">[</span><span class="s1">&#39;UCL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UCL</span><span class="p">;</span> <span class="n">cc_df</span><span class="p">[</span><span class="s1">&#39;LCL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LCL</span>
<span class="n">cc_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;synthetic_control_chart_data.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;individuals_control_chart_illustration.png&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">save_fig_kwargs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="summary-tables-and-method-selection">
<h1><span class="section-number">4.5. </span>Summary Tables and Method Selection<a class="headerlink" href="#summary-tables-and-method-selection" title="Link to this heading">#</a></h1>
<section id="visual-method-categories-and-use-cases">
<h2><span class="section-number">4.5.1. </span>Visual Method Categories and Use Cases<a class="headerlink" href="#visual-method-categories-and-use-cases" title="Link to this heading">#</a></h2>
<section id="distribution-analysis-methods">
<h3><span class="section-number">4.5.1.1. </span>Distribution Analysis Methods<a class="headerlink" href="#distribution-analysis-methods" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Primary Purpose</p></th>
<th class="head"><p>Best Use Cases</p></th>
<th class="head"><p>Key Strengths</p></th>
<th class="head"><p>Limitations</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Histograms</strong></p></td>
<td><p>Distribution shape and tail analysis</p></td>
<td><p>Initial data exploration, identifying heavy tails, seasonal comparisons</p></td>
<td><p>Clear visual of distribution shape, easy to spot tail outliers, good for grouped analysis</p></td>
<td><p>Bin selection affects interpretation, may miss temporal patterns</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Box Plots</strong></p></td>
<td><p>Quartile-based outlier detection</p></td>
<td><p>Quick outlier screening, time period comparisons, contextual outlier detection</p></td>
<td><p>Automatic outlier flagging (1.5×IQR), robust to extreme values, great for grouped data</p></td>
<td><p>Limited distribution detail, may flag legitimate extreme values</p></td>
</tr>
<tr class="row-even"><td><p><strong>Violin Plots</strong></p></td>
<td><p>Distribution density visualization</p></td>
<td><p>Seasonal data analysis, complex distribution shapes, multi-modal data</p></td>
<td><p>Shows full distribution density, better than box plots for shape, good for cyclical patterns</p></td>
<td><p>More complex to interpret, requires larger sample sizes</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Q-Q Plots</strong></p></td>
<td><p>Distributional assumption testing</p></td>
<td><p>Normality assessment, model validation, theoretical distribution comparison</p></td>
<td><p>Precise distributional testing, clear departure visualization, statistical rigor</p></td>
<td><p>Requires distributional knowledge, less intuitive interpretation</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="relationship-and-pattern-methods">
<h3><span class="section-number">4.5.1.2. </span>Relationship and Pattern Methods<a class="headerlink" href="#relationship-and-pattern-methods" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Primary Purpose</p></th>
<th class="head"><p>Best Use Cases</p></th>
<th class="head"><p>Key Strengths</p></th>
<th class="head"><p>Limitations</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Time Plots</strong></p></td>
<td><p>Chronological pattern visualization</p></td>
<td><p>Initial data inspection, trend identification, seasonal pattern recognition</p></td>
<td><p>Intuitive interpretation, shows temporal context, reveals all outlier types</p></td>
<td><p>Can be overwhelming with noise, difficult with multiple series</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Scatter Plots</strong></p></td>
<td><p>Relationship analysis</p></td>
<td><p>Trend deviations, correlation assessment, multi-variable relationships</p></td>
<td><p>Clear relationship visualization, identifies leverage points, good for regression analysis</p></td>
<td><p>Limited to pairwise relationships, can be cluttered with large data</p></td>
</tr>
<tr class="row-even"><td><p><strong>Lag Plots</strong></p></td>
<td><p>Temporal dependency analysis</p></td>
<td><p>Autocorrelation assessment, pattern disruption detection, structural change identification</p></td>
<td><p>Reveals temporal relationships, detects structural outliers, shows variance changes</p></td>
<td><p>Requires understanding of lags, may miss longer-term patterns</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Residual Plots</strong></p></td>
<td><p>Model validation and outlier detection</p></td>
<td><p>Post-modeling analysis, model adequacy assessment, unexplained variation identification</p></td>
<td><p>Model-independent outliers, validates assumptions, quantifies outlier impact</p></td>
<td><p>Requires fitted model, model choice affects results</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="decomposition-and-monitoring-methods">
<h3><span class="section-number">4.5.1.3. </span>Decomposition and Monitoring Methods<a class="headerlink" href="#decomposition-and-monitoring-methods" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Primary Purpose</p></th>
<th class="head"><p>Best Use Cases</p></th>
<th class="head"><p>Key Strengths</p></th>
<th class="head"><p>Limitations</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Seasonal Decomposition</strong></p></td>
<td><p>Component separation</p></td>
<td><p>Complex seasonal data, trend-season separation, structural outlier detection</p></td>
<td><p>Isolates different components, highlights residual outliers, handles complex seasonality</p></td>
<td><p>Requires seasonal data, method choice affects results</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Control Charts</strong></p></td>
<td><p>Process monitoring</p></td>
<td><p>Real-time monitoring, process control, continuous surveillance</p></td>
<td><p>Statistical control limits, pattern recognition rules, ongoing monitoring capability</p></td>
<td><p>Assumes process stability, may have false alarms</p></td>
</tr>
<tr class="row-even"><td><p><strong>Normal Probability Plots</strong></p></td>
<td><p>Normality-specific testing</p></td>
<td><p>Manufacturing quality control, process capability analysis, normality validation</p></td>
<td><p>Designed for normal distribution, clear linear relationship, industry standard</p></td>
<td><p>Limited to normal assumption, less flexible than Q-Q plots</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<hr class="docutils" />
<section id="method-selection-guidelines">
<h2><span class="section-number">4.5.2. </span>Method Selection Guidelines<a class="headerlink" href="#method-selection-guidelines" title="Link to this heading">#</a></h2>
<section id="recommended-method-combinations-by-data-type">
<h3><span class="section-number">4.5.2.1. </span>Recommended Method Combinations by Data Type<a class="headerlink" href="#recommended-method-combinations-by-data-type" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Data Characteristics</p></th>
<th class="head"><p>Primary Methods</p></th>
<th class="head"><p>Secondary Methods</p></th>
<th class="head"><p>Analysis Sequence</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Simple Time Trend</strong></p></td>
<td><p>Time Plot, Scatter Plot</p></td>
<td><p>Residual Plot, Control Chart</p></td>
<td><p>1. Time Plot → 2. Scatter Plot → 3. Residual Analysis</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Seasonal Data</strong></p></td>
<td><p>Time Plot, Seasonal Decomposition</p></td>
<td><p>Box Plot (by season), Violin Plot</p></td>
<td><p>1. Time Plot → 2. Seasonal Decomposition → 3. Residual Analysis</p></td>
</tr>
<tr class="row-even"><td><p><strong>High-Frequency Data</strong></p></td>
<td><p>Control Chart, Box Plot (by period)</p></td>
<td><p>Histogram, Lag Plot</p></td>
<td><p>1. Control Chart → 2. Box Plot → 3. Lag Analysis</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Non-Normal Distribution</strong></p></td>
<td><p>Histogram, Q-Q Plot</p></td>
<td><p>Time Plot, Residual Plot</p></td>
<td><p>1. Histogram → 2. Q-Q Plot → 3. Transform if needed</p></td>
</tr>
<tr class="row-even"><td><p><strong>Multiple Variables</strong></p></td>
<td><p>Scatter Plot Matrix, Time Plot</p></td>
<td><p>Residual Plot, Cross-correlation</p></td>
<td><p>1. Individual Time Plots → 2. Scatter Matrix → 3. Joint Analysis</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="analysis-phase-recommendations">
<h3><span class="section-number">4.5.2.2. </span>Analysis Phase Recommendations<a class="headerlink" href="#analysis-phase-recommendations" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Analysis Phase</p></th>
<th class="head"><p>Recommended Methods</p></th>
<th class="head"><p>Objective</p></th>
<th class="head"><p>Key Questions</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Initial Exploration</strong></p></td>
<td><p>Time Plot, Histogram</p></td>
<td><p>Understand basic patterns</p></td>
<td><p>What’s the overall pattern? Any obvious outliers? Is there seasonality?</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Distribution Assessment</strong></p></td>
<td><p>Box Plot, Q-Q Plot, Violin Plot</p></td>
<td><p>Characterize data distribution</p></td>
<td><p>What’s the distribution shape? Are there tail outliers? Do assumptions hold?</p></td>
</tr>
<tr class="row-even"><td><p><strong>Relationship Analysis</strong></p></td>
<td><p>Scatter Plot, Lag Plot</p></td>
<td><p>Examine dependencies</p></td>
<td><p>Are there trends? What are the correlations? Any structural breaks?</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Model-Based Detection</strong></p></td>
<td><p>Residual Plot, Seasonal Decomposition</p></td>
<td><p>Model-independent outliers</p></td>
<td><p>What can’t the model explain? Are residuals well-behaved? Any component outliers?</p></td>
</tr>
<tr class="row-even"><td><p><strong>Ongoing Monitoring</strong></p></td>
<td><p>Control Chart, Time Plot</p></td>
<td><p>Continuous surveillance</p></td>
<td><p>Is the process in control? Any new patterns emerging? When to investigate?</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<hr class="docutils" />
<section id="other-notable-methods-reference-only">
<h2><span class="section-number">4.5.3. </span>Other Notable Methods (Reference Only)<a class="headerlink" href="#other-notable-methods-reference-only" title="Link to this heading">#</a></h2>
<section id="advanced-visualization-techniques">
<h3><span class="section-number">4.5.3.1. </span>Advanced Visualization Techniques<a class="headerlink" href="#advanced-visualization-techniques" title="Link to this heading">#</a></h3>
<p><strong>Heatmaps and Calendar Plots</strong></p>
<ul class="simple">
<li><p>Purpose: Visualize patterns across multiple time dimensions simultaneously</p></li>
<li><p>Use Case: Identifying day-of-week and hour-of-day anomaly patterns</p></li>
<li><p>Example: Website traffic heatmaps showing unusual activity patterns</p></li>
</ul>
<p><strong>Parallel Coordinate Plots</strong></p>
<ul class="simple">
<li><p>Purpose: Multi-dimensional outlier detection across multiple time series variables</p></li>
<li><p>Use Case: Simultaneous monitoring of multiple related metrics</p></li>
<li><p>Example: Manufacturing process parameters displayed as parallel coordinates</p></li>
</ul>
<p><strong>Andrews Plots</strong></p>
<ul class="simple">
<li><p>Purpose: Transform multivariate time series data into functional representations</p></li>
<li><p>Use Case: Detecting outliers in high-dimensional time series data</p></li>
<li><p>Example: Financial portfolio analysis with multiple asset returns</p></li>
</ul>
</section>
<section id="specialized-statistical-methods">
<h3><span class="section-number">4.5.3.2. </span>Specialized Statistical Methods<a class="headerlink" href="#specialized-statistical-methods" title="Link to this heading">#</a></h3>
<p><strong>Mahalanobis Distance Plots</strong></p>
<ul class="simple">
<li><p>Purpose: Multivariate outlier detection accounting for variable correlations</p></li>
<li><p>Use Case: Complex systems with correlated measurements</p></li>
<li><p>Example: Environmental monitoring with multiple sensor types</p></li>
</ul>
<p><strong>Influence Function Plots</strong></p>
<ul class="simple">
<li><p>Purpose: Measure how individual observations affect statistical estimates</p></li>
<li><p>Use Case: Robust statistics and influential point identification</p></li>
<li><p>Example: Economic forecasting model diagnostics</p></li>
</ul>
<p><strong>Spectral Analysis Plots (Periodograms)</strong></p>
<ul class="simple">
<li><p>Purpose: Frequency domain outlier detection for periodic data</p></li>
<li><p>Use Case: Signal processing and cyclical anomaly detection</p></li>
<li><p>Example: Biomedical signal analysis for abnormal rhythms</p></li>
</ul>
</section>
<section id="machine-learning-visualization">
<h3><span class="section-number">4.5.3.3. </span>Machine Learning Visualization<a class="headerlink" href="#machine-learning-visualization" title="Link to this heading">#</a></h3>
<p><strong>Isolation Forest Plots</strong></p>
<ul class="simple">
<li><p>Purpose: Visualize algorithmic outlier detection results</p></li>
<li><p>Use Case: High-dimensional data with complex outlier patterns</p></li>
<li><p>Example: Cybersecurity anomaly detection visualization</p></li>
</ul>
<p><strong>Local Outlier Factor (LOF) Plots</strong></p>
<ul class="simple">
<li><p>Purpose: Density-based outlier visualization</p></li>
<li><p>Use Case: Irregularly distributed data with varying densities</p></li>
<li><p>Example: Spatial-temporal data analysis</p></li>
</ul>
<p><strong>Reconstruction Error Plots (Autoencoders)</strong></p>
<ul class="simple">
<li><p>Purpose: Neural network-based anomaly visualization</p></li>
<li><p>Use Case: Complex, non-linear time series patterns</p></li>
<li><p>Example: Industrial IoT sensor data monitoring</p></li>
</ul>
</section>
<section id="interactive-and-dynamic-methods">
<h3><span class="section-number">4.5.3.4. </span>Interactive and Dynamic Methods<a class="headerlink" href="#interactive-and-dynamic-methods" title="Link to this heading">#</a></h3>
<p><strong>Brushing and Linking</strong></p>
<ul class="simple">
<li><p>Purpose: Interactive exploration across multiple linked plots</p></li>
<li><p>Use Case: Complex exploratory data analysis</p></li>
<li><p>Example: Financial market analysis with multiple instruments</p></li>
</ul>
<p><strong>Animation Plots</strong></p>
<ul class="simple">
<li><p>Purpose: Temporal evolution visualization</p></li>
<li><p>Use Case: Understanding outlier development over time</p></li>
<li><p>Example: Pandemic spread pattern analysis</p></li>
</ul>
<p><strong>Zoom and Pan Interfaces</strong></p>
<ul class="simple">
<li><p>Purpose: Multi-scale outlier investigation</p></li>
<li><p>Use Case: High-resolution time series with nested patterns</p></li>
<li><p>Example: High-frequency trading anomaly detection</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapter_04"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Intro2TS_C04S03.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">4.3. </span>Outlier Classification by Seasonality</p>
      </div>
    </a>
    <a class="right-next"
       href="Intro2TS_C04S05.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">4.6. </span>Major Statistical Methods for Outlier Detection in Time Series</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">4.4. Time Series Outlier Detection: Visual Methods</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#time-plots-line-plots">4.4.1. Time Plots (Line Plots)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#histograms">4.4.2. Histograms</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#box-plots-box-and-whisker">4.4.3. Box Plots (Box-and-Whisker)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scatter-plots-lag-plots">4.4.4. Scatter Plots (Lag Plots)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#violin-plots-grouped-by-time-unit">4.4.5. Violin Plots (Grouped by Time Unit)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonal-decomposition-plots">4.4.6. Seasonal Decomposition Plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q-q-plots-quantile-quantile-plots">4.4.7. Q-Q Plots (Quantile-Quantile Plots)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#normal-probability-plots-alternative-to-q-q-plots">4.4.8. Normal Probability Plots (Alternative to Q-Q Plots)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#residual-plots">4.4.9. Residual Plots</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#control-charts-statistical-process-control">4.4.10. Control Charts (Statistical Process Control)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-tables-and-method-selection">4.5. Summary Tables and Method Selection</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-method-categories-and-use-cases">4.5.1. Visual Method Categories and Use Cases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distribution-analysis-methods">4.5.1.1. Distribution Analysis Methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#relationship-and-pattern-methods">4.5.1.2. Relationship and Pattern Methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decomposition-and-monitoring-methods">4.5.1.3. Decomposition and Monitoring Methods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#method-selection-guidelines">4.5.2. Method Selection Guidelines</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-method-combinations-by-data-type">4.5.2.1. Recommended Method Combinations by Data Type</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-phase-recommendations">4.5.2.2. Analysis Phase Recommendations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-notable-methods-reference-only">4.5.3. Other Notable Methods (Reference Only)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-visualization-techniques">4.5.3.1. Advanced Visualization Techniques</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specialized-statistical-methods">4.5.3.2. Specialized Statistical Methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-learning-visualization">4.5.3.3. Machine Learning Visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-and-dynamic-methods">4.5.3.4. Interactive and Dynamic Methods</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Hatef Dastour
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>